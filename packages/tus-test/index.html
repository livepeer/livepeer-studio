<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/tus-js-client@latest/dist/tus.min.js"></script>
  </head>
  <body>
    <input type="file" id="file1" onchange="trigger()" />
    <script>
      function trigger() {
        //const base = `/Users/victorges/workspace/test-videos/`;
        //const filename = `rtm.mp4`;
        const base = `/home/gioele/Downloads/`;
        const filename = `bbbx3_720_2s.mp4`;
        const path = base + filename;

        // load the file from file1 id
        const file = document.getElementById("file1").files[0];
        const size = file.size;
        const fileType = file.type;

        async function doUpload() {
          let uploadUrl = null;

          // do the same with xhr
          var xhr = new XMLHttpRequest();
          xhr.file = file; // not necessary if you create scopes like this
          xhr.addEventListener(
            "progress",
            function (e) {
              var done = e.position || e.loaded,
                total = e.totalSize || e.total;
              console.log(
                "xhr progress: " + Math.floor((done / total) * 1000) / 10 + "%"
              );
            },
            false
          );
          if (xhr.upload) {
            xhr.upload.onprogress = function (e) {
              var done = e.position || e.loaded,
                total = e.totalSize || e.total;
              console.log(
                "xhr.upload progress: " +
                  done +
                  " / " +
                  total +
                  " = " +
                  Math.floor((done / total) * 1000) / 10 +
                  "%"
              );
            };
          }
          xhr.onreadystatechange = function (e) {
            if (4 == this.readyState) {
              console.log(["xhr upload complete", e]);
              let jsonres = JSON.parse(this.responseText);
              uploadUrl = jsonres.data.tusEndpoint;
            }
          };

          xhr.open(
            "post",
            "http://localhost:3004/api/asset/request-upload",
            true
          );
          xhr.setRequestHeader("Content-Type", "multipart/form-data");
          xhr.setRequestHeader(
            "Authorization",
            "Bearer " + "0faee6cf-0000-0000-b026-348bcdb59e84"
          );
          xhr.send(file);

          console.log(uploadUrl);

          const upload = new tus.Upload(file, {
            endpoint: uploadUrl,
            metadata: {
              filename,
              filetype: "video/mp4",
            },
            uploadSize: size,
            onError(error) {
              console.log(error);
              throw error;
            },
            onProgress(bytesUploaded, bytesTotal) {
              console.log(upload.url);
              const percentage = ((bytesUploaded / bytesTotal) * 100).toFixed(
                2
              );
              console.log(bytesUploaded, bytesTotal, `${percentage}%`);
            },
            onSuccess() {
              console.log("Upload finished:", upload.url);
            },
          });

          upload.findPreviousUploads().then(function (previousUploads) {
            console.log("LOOKING FOR PREVIOUS UPLOADS");
            console.log(previousUploads);
            // Found previous uploads so we select the first one.
            if (previousUploads.length) {
              console.log(previousUploads);
              //upload.resumeFromPreviousUpload(previousUploads[0])
            } else {
              upload.start();
            }

            // Start the upload
            //upload.start();
          });
        }

        doUpload().catch((err) =>
          console.error("Error uploading:", err.message)
        );
      }
    </script>
  </body>
</html>
